<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Calendar with Classroom Schedule</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            max-width: 600px;
            margin: auto;
        }

        .calendar div {
            padding: 20px;
            border: 1px solid #ddd;
            text-align: center;
            cursor: pointer;
        }

        .header {
            grid-column: span 7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-names {
            grid-column: span 7;
            display: contents;
        }

        .day-names div {
            background-color: #f0f0f0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .classroom-list {
            list-style-type: none;
            padding: 0;
        }

        .classroom-list li {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .occupied {
            background-color: #d3d3d3;
        }

        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            margin-top: 10px;
        }

        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 10px 15px;
            transition: 0.3s;
        }

        .tab button:hover {
            background-color: #ddd;
        }

        .tab button.active {
            background-color: #ccc;
        }

        .tabcontent {
            display: none;
            padding: 20px;
            border-top: none;
        }
    </style>
</head>

<body>
    <div class="calendar" id="calendar">
        <div class="header">
            <button onclick="changeMonth(-1)">Previous</button>
            <h2 id="monthYear"></h2>
            <button onclick="changeMonth(1)">Next</button>
        </div>
        <div class="day-names">
            <div>Sun</div>
            <div>Mon</div>
            <div>Tue</div>
            <div>Wed</div>
            <div>Thu</div>
            <div>Fri</div>
            <div>Sat</div>
        </div>
    </div>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="selectedDate"></h2>
            <div class="tab">
                <button class="tablinks" onclick="openTab(event, 'setEventTab')">Set an Event</button>
                <button class="tablinks" onclick="openTab(event, 'eventsTab')">Events</button>
            </div>
            <div id="setEventTab" class="tabcontent">
                <div id="classroomContainer">
                    <ul id="classroomList" class="classroom-list"></ul>
                </div>
            </div>
            <div id="eventsTab" class="tabcontent">
                <ul id="eventsList" class="classroom-list"></ul>
            </div>
        </div>
    </div>

    <div id="setEventModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSetEventModal()">&times;</span>
            <h2>Set Event Details</h2>
            <p>Selected Date: <span id="selectedEventDate"></span></p>
            <p>Selected Classroom: <span id="selectedClassroom"></span></p>
            <label for="groupName">Study Group Name:</label>
            <select id="groupNameSelect"></select><br><br>
            <label for="groupSize">Number of People:</label>
            <select id="groupSize">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
            </select><br><br>
            <button onclick="setEvent()">Set</button>
        </div>
    </div>

    <script>
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        const monthNames = ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"];

        const classrooms = [
            {
                "classroom": "101",
                "working_hours": "8:00 AM - 5:00 PM"
            },
            {
                "classroom": "102",
                "working_hours": "8:30 AM - 5:30 PM"
            },
            {
                "classroom": "103",
                "working_hours": "9:00 AM - 6:00 PM"
            },
            {
                "classroom": "104",
                "working_hours": "8:00 AM - 4:00 PM"
            },
            {
                "classroom": "105",
                "working_hours": "8:00 AM - 5:00 PM"
            },
            {
                "classroom": "106",
                "working_hours": "9:00 AM - 6:00 PM"
            },
            {
                "classroom": "107",
                "working_hours": "8:00 AM - 3:00 PM"
            },
            {
                "classroom": "108",
                "working_hours": "10:00 AM - 7:00 PM"
            },
            {
                "classroom": "109",
                "working_hours": "8:00 AM - 5:00 PM"
            },
            {
                "classroom": "110",
                "working_hours": "8:30 AM - 4:30 PM"
            },
            {
                "classroom": "111",
                "working_hours": "9:00 AM - 6:00 PM"
            },
            {
                "classroom": "112",
                "working_hours": "8:00 AM - 4:00 PM"
            },
            {
                "classroom": "113",
                "working_hours": "8:00 AM - 5:00 PM"
            },
            {
                "classroom": "114",
                "working_hours": "9:30 AM - 5:30 PM"
            },
            {
                "classroom": "115",
                "working_hours": "8:00 AM - 3:00 PM"
            },
            {
                "classroom": "116",
                "working_hours": "8:00 AM - 4:00 PM"
            },
            {
                "classroom": "117",
                "working_hours": "9:00 AM - 5:00 PM"
            },
            {
                "classroom": "118",
                "working_hours": "8:00 AM - 6:00 PM"
            },
            {
                "classroom": "119",
                "working_hours": "8:30 AM - 4:30 PM"
            },
            {
                "classroom": "120",
                "working_hours": "8:00 AM - 5:00 PM"
            }
        ];

        function renderCalendar(month, year) {
            const calendar = document.getElementById('calendar');
            const monthYear = document.getElementById('monthYear');
            monthYear.textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month).getDay();
            const daysInMonth = 32 - new Date(year, month, 32).getDate();

            // Clear previous cells
            const days = calendar.querySelectorAll('.day');
            days.forEach(day => day.remove());

            // Create blank cells for days before the first day of the month
            for (let i = 0; i < firstDay; i++) {
                const cell = document.createElement('div');
                cell.classList.add('day');
                calendar.appendChild(cell);
            }

            // Create cells for each day of the month
            for (let i = 1; i <= daysInMonth; i++) {
                const cell = document.createElement('div');
                cell.classList.add('day');
                const dateKey = `${month}-${i}-${year}`;
                if (classrooms.length > 0) {
                    cell.classList.add('occupied');
                }
                cell.textContent = i;
                cell.onclick = function () {
                    showModal(month, i, year);
                };
                calendar.appendChild(cell);
            }
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentMonth, currentYear);
        }

        let occupiedClassrooms = [];

        function showModal(month, day, year) {
            const modal = document.getElementById('myModal');
            const selectedDate = document.getElementById('selectedDate');
            const setEventTab = document.getElementById('setEventTab');
            const eventsTab = document.getElementById('eventsTab');
            const tablinks = document.getElementsByClassName("tablinks");

            // Format the date as YYYY-MM-DD
            const formattedDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            selectedDate.textContent = formattedDate;

            // Display Set an Event tab by default
            openTab(event, 'setEventTab');

            // Clear previous list items
            const classroomList = document.getElementById('classroomList');
            classroomList.innerHTML = '';

            // Fetch and display events for the selected date
            fetchEvents2(formattedDate).then(() => {
                // Filter out occupied classrooms
                const availableClassrooms = classrooms.filter(classroomElement => !occupiedClassrooms.includes(classroomElement.classroom));
                console.log(availableClassrooms);
                availableClassrooms.forEach(classroom => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${classroom.classroom} (${classroom.working_hours})`;
                    listItem.onclick = function () {
                        selectClassroom(classroom.classroom, formattedDate);
                    };
                    classroomList.appendChild(listItem);
                });
            });

            modal.style.display = 'block';
        }


        function convertToDate(dateStr) {
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = ('0' + (date.getMonth() + 1)).slice(-2); // Months are zero-based
            const day = ('0' + date.getDate()).slice(-2);
            return `${year}-${month}-${day}`;
        }

        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            const tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            if (tabName === 'eventsTab') {
                const selectedDate = document.getElementById('selectedDate').textContent;
                console.log("what" + selectedDate);
                // Convert date to "YYYY-MM-DD" format for fetching events
                const formattedDate = convertToDate(selectedDate);
                fetchEvents2(formattedDate);
            }
        }

        function selectClassroom(classroom, date) {
            closeModal();
            openSetEventModal(classroom, date);
        }

        function openSetEventModal(classroom, date) {
            const setEventModal = document.getElementById('setEventModal');
            setEventModal.style.display = 'block';
            // Set the selected date and classroom in the set event modal
            document.getElementById('selectedEventDate').textContent = date;
            document.getElementById('selectedClassroom').textContent = classroom;

            // Fetch group names from backend (PHP script)
            fetchGroupNames().then(groupNames => {
                const groupNameSelect = document.getElementById('groupNameSelect');
                groupNameSelect.innerHTML = '';
                groupNames.forEach(group => {
                    const option = document.createElement('option');
                    option.textContent = group.GroupName + " " + group.GroupID;
                    groupNameSelect.appendChild(option);
                });
            }).catch(error => {
                console.error('Error fetching group names:', error);
                // Optionally handle errors here
            });

            // Populate the number of people dropdown
            const groupSizeSelect = document.getElementById('groupSize');
            groupSizeSelect.value = '1'; // Set default value
        }

        async function fetchGroupNames() {
            try {
                const response = await fetch('get-group-names.php');
                if (!response.ok) {
                    throw new Error('Failed to fetch group names');
                }
                const groupNames = await response.json();
                return groupNames;
            } catch (error) {
                throw error;
            }
        }

        function closeSetEventModal() {
            const setEventModal = document.getElementById('setEventModal');
            setEventModal.style.display = 'none';
        }

        function setEvent() {
            const groupNameSelect = document.getElementById('groupNameSelect');
            const groupName = groupNameSelect.options[groupNameSelect.selectedIndex].text;
            const groupSizeSelect = document.getElementById('groupSize');
            const groupSize = groupSizeSelect.options[groupSizeSelect.selectedIndex].value;
            const selectedDate = document.getElementById('selectedDate').textContent;
            const selectedClassroom = document.getElementById('selectedClassroom').textContent;

            // Prepare data to send to PHP
            const formData = new FormData();
            formData.append('groupID', groupName.split(" ").pop());
            const lastSpaceIndex = groupName.lastIndexOf(' ');
            formData.append('groupName', groupName.substring(0, lastSpaceIndex));
            formData.append('groupSize', groupSize);
            formData.append('selectedDate', selectedDate);
            formData.append('selectedClassroom', selectedClassroom);

            // Send AJAX request to insert-event.php
            fetch('insert-event.php', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to insert event');
                    }
                    return response.text();
                })
                .then(data => {
                    console.log(data); // Log success message (optional)
                    // Optionally, you can update the UI or perform any other actions on success
                    closeSetEventModal(); // Close the modal after successful insertion
                })
                .catch(error => {
                    console.error('Error inserting event:', error);
                    // Optionally handle errors here (e.g., show an error message to the user)
                });
        }

        function closeModal() {
            const modal = document.getElementById('myModal');
            modal.style.display = 'none';
        }

        window.onclick = function (event) {
            const modal = document.getElementById('myModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        function fetchEvents(date) {
            console.log("Fetching events for: " + date);
            return fetch(`get-classroom-events.php?date=${encodeURIComponent(date)}`)
                .then(response => response.json())
                .then(data => {
                    console.log("data1 :");
                    console.log(data);
                    const groupsToCheck = [];
                    occupiedClassrooms = data.map(event => {
                        groupsToCheck.push(event.StudyGroupID);
                        return event.ClassroomID.toString();
                    });
                    fetch('check-if-user-is-in-groups.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: groupsToCheck
                    })
                        .then(response => response.json())
                        .then(data => console.log(data))
                        .catch(error => console.error('Error:', error));

                    const eventsList = document.getElementById('eventsList');
                    eventsList.innerHTML = '';  // Clear previous events

                    if (data.length === 0) {
                        const noEventsMessage = document.createElement('li');
                        noEventsMessage.textContent = "No events on this day";
                        eventsList.appendChild(noEventsMessage);
                    } else {
                        data.forEach(event => {
                            const eventItem = document.createElement('li');
                            eventItem.textContent = `Group ID: ${event.StudyGroupID}, Group Name: ${event.StudyGroupName}, Classroom: ${event.ClassroomID}, Students: ${event.NumberOfStudents}`;
                            eventsList.appendChild(eventItem);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                });
        }

        async function fetchEvents2(date) {
            console.log("Fetching events for: " + date);
            try {
                const responseEvents = await fetch(`get-classroom-events.php?date=${encodeURIComponent(date)}`);
                const dataEvents = await responseEvents.json();
                console.log("Fetched events data:");
                console.log(dataEvents);

                const groupsToCheck = [];
                occupiedClassrooms = dataEvents.map(event => {
                    groupsToCheck.push(event.StudyGroupID);
                    return event.ClassroomID.toString();
                });

                const responseGroups = await fetch('check-if-user-is-in-groups.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ group_ids: groupsToCheck })
                });
                const dataGroups = await responseGroups.json();
                console.log("Groups check result:");
                console.log(dataGroups);

                const eventsList = document.getElementById('eventsList');
                eventsList.innerHTML = '';  // Clear previous events

                if (dataEvents.length === 0) {
                    const noEventsMessage = document.createElement('li');
                    noEventsMessage.textContent = "No events on this day";
                    eventsList.appendChild(noEventsMessage);
                } else {
                    dataEvents.forEach(event => {
                        const eventItem = document.createElement('li');
                        console.log("Event object:");
                        console.log(event);

                        if (dataGroups[event.StudyGroupID]) {
                            eventItem.innerHTML = `
                        Group ID: ${event.StudyGroupID}, 
                        Group Name: ${event.StudyGroupName}, 
                        Classroom: ${event.ClassroomID}, 
                        Students: ${event.NumberOfStudents} 
                        <button onClick="changeNumOfStudents(${event.EventID})">Edit number of students</button> 
                        <button onClick="removeEvent(${event.EventID},${event.ClassroomID})">Delete</button>`;
                        } else {
                            eventItem.innerHTML = `
                        Group ID: ${event.StudyGroupID}, 
                        Group Name: ${event.StudyGroupName}, 
                        Classroom: ${event.ClassroomID}, 
                        Students: ${event.NumberOfStudents}`;
                        }
                        eventsList.appendChild(eventItem);
                    });
                }
            } catch (error) {
                console.error('Error fetching events:', error);
            }
        }

        function changeNumOfStudents(eventID) {
            console.log("changeNumOfStudents called with EventID:", eventID); // Log EventID

            // Function to validate input and prompt until valid input is provided
            function promptForNumberOfStudents() {
                let input = prompt("Enter the new number of students (between 1 and 6):");
                if (input === null) {
                    return null; // User clicked Cancel
                }
                input = parseInt(input);
                if (isNaN(input) || input < 1 || input > 6) {
                    alert("Please enter a number between 1 and 6.");
                    return promptForNumberOfStudents(); // Prompt again if input is invalid
                }
                return input;
            }

            const newNumberOfStudents = promptForNumberOfStudents();

            if (newNumberOfStudents !== null) {
                fetch('change-num-of-students-event.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ event_id: eventID, new_number_of_students: newNumberOfStudents })
                })
                    .then(response => response.text())
                    .then(data => {
                        if (data === 'success') {
                            alert('Number of students updated successfully.');
                            fetchEvents2(document.getElementById('selectedDate').textContent);
                        } else {
                            alert('Error updating number of students.');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }


        function removeEvent(eventID, classroomID) {
            console.log("removeEvent called with EventID:", eventID);  // Log EventID
            if (confirm("Are you sure you want to delete this event?")) {
                fetch('remove-event.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ event_id: eventID })
                })
                    .then(response => response.text())
                    .then(data => {
                        if (data === 'success') {
                            alert('Event removed successfully.');
                            fetchEvents2(document.getElementById('selectedDate').textContent);
                        } else {
                            alert('Error removing event.');
                        }
                    }).then(() => {
                        // Filter out occupied classrooms
                        const classroomList = document.getElementById('classroomList');
                        classroomList.innerHTML = '';
                        const updatedOccupiedClassrooms = occupiedClassrooms.filter(classroom => classroom !== classroomID.toString())
                        const availableClassrooms = classrooms.filter(classroomElement => !updatedOccupiedClassrooms.includes(classroomElement.classroom));
                        availableClassrooms.forEach(classroom => {
                            const listItem = document.createElement('li');
                            listItem.textContent = `${classroom.classroom} (${classroom.working_hours})`;
                            listItem.onclick = function () {
                                selectClassroom(classroom.classroom, formattedDate);
                            };
                            classroomList.appendChild(listItem);
                        });
                    })

                    .catch(error => console.error('Error:', error));
            }
        }




        renderCalendar(currentMonth, currentYear);
    </script>
</body>

</html>